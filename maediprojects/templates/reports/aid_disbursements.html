{% set active_page='aid_disbursements' %}{% extends "layout2.html" %}
{% block title %}{{ _('Aid disbursement tracking') }}{% endblock %}
{% block content %}
<b-row>
  <b-col>
    <b-row>
      <b-col cols="9">
        <h1>Aid disbursement tracking</h1>
        <p class="lead">Showing [[ activities.length ]]Â aid activities with planned disbursements over
        USD 1 million. Planned and actual disbursements are restricted to amounts in [[ fy_text ]] only.</p>
      </b-col>
      <b-col cols="3">
        <b-form-group label="Select fiscal year"
          label-class="font-weight-bold">
          <b-form-select :options="fiscalYears"
          v-model="fiscalYear">
          </b-form-select>
        </b-form-group>
      </b-col>
    </b-row>
    <b-table class="table" :busy="isBusy" :fields="fields" :items="activities" sort-by="pct" sort-desc="true" :tbody-tr-class="rowClass">
      <div slot="table-busy" class="text-center">
        <b-spinner class="align-middle" label="Loading..."></b-spinner>
        <strong>Loading...</strong>
      </div>
      <template slot="thead-top" slot-scope="data">
        <b-tr>
          <b-th colspan="5" class="text-center">Financial reporting for [[ fy_text ]] only</b-th>
        </b-tr>
      </template>
      <template slot="[title]" slot-scope="data">
        <a :href="data.item.url">[[ data.item.title ]]</a>
      </template>
      <template slot="[sum_forwardspends]" slot-scope="data">
        [[ numberFormatter(data.item.sum_forwardspends) ]]
      </template>
      <template slot="[sum_disbursements]" slot-scope="data">
        [[ numberFormatter(data.item.sum_disbursements) ]]
      </template>
      <template slot="[pct]" slot-scope="data">
        <template v-if="data.item.isTime">
          <b-progress :max="100" show-value variant="warning">
            <b-progress-bar :value="data.item.pct">
              [[ data.item.pct ]]%
            </b-progress-bar>
          </b-progress>
        </template>
        <template v-else>
          <b-progress :max="100" show-value>
            <b-progress-bar :value="data.item.pct">
              [[ data.item.pct ]]%
            </b-progress-bar>
          </b-progress>
        </template>
      </template>
    </b-table>
  </b-col>
</b-row>
{% endblock %}
{% block vuejs %}
<script>
var api_base = "{{ url_for('api.api', _external=True)}}";
Vue.config.devtools = true
new Vue({
  el: "#app",
  delimiters: ["[[", "]]"],
  data() {
    return {
      fields: [
        {
          key: 'title',
          label: 'Title',
          sortable: true
        },
        {
          key: 'reporting_org_name',
          label: 'Reported by',
          sortable: true
        },
        {
          key: 'sum_forwardspends',
          label: 'Planned disbursements',
          class: 'number',
          sortable: true
        },
        {
          key: 'sum_disbursements',
          label: 'Actual disbursements',
          class: 'number',
          sortable: true
        },
        {
          key: 'pct',
          label: '% Disbursed',
          class: 'number width-25pct',
          sortable: true
        }
      ],
      activities: [],
      isBusy: true,
      fiscalYear: '2018',
      fiscalYears: ['2015', '2016', '2017', '2018', '2019', '2020']
    }
  },
  mounted: function() {
    this.getReportData()
  },
  watch: {
    fiscalYear: function() {
      this.getReportData()
    }
  },
  computed: {
    fy_text() {
      return `FY${this.fiscalYear.slice(-2)}`
    }
  },
  methods: {
    rowClass(item, type) {
      if (!item) return
      if (item.isTime) { return 'table-warning' }
    },
    numberFormatter(value) {
      if (value == null) { return "" }
      return "$" + value.toLocaleString(undefined, {maximumFractionDigits: 0})
    },
    getReportData: function() {
      axios
        .get(`${api_base}disbursements/aid/`, {
          params: { fiscal_year: this.fiscalYear }
        })
        .then((response) => {
          var timeActivity = {
            title: `Rough expected disbursement, given ${response.data.days_since_fy_began} days since start of the fiscal year`,
            pct: response.data.progress_time,
            isTime: true
          }
          this.activities = response.data.activities
          this.activities.push(timeActivity)
          this.isBusy = false
        });
    }
  }
})
</script>
{% endblock %}