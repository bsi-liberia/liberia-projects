{% set active_page='results' %}{% extends "layout2.html" %}
{% block title %}{{ _('Results') }}{% endblock %}
{% block content %}
<h1>Results<template v-if="activity_title"> for [[ activity_title ]]</template></h1>
<b-form @submit.stop.prevent="saveResultsSubmitCheck" style="margin-bottom: 10px">
  <b-row lg="9">
    <b-col>
      <p class="lead">This interface allows you to provide results
        data for your activities. The indicators should be consistent
        with your project results framework.</p>
    </b-col>
    <b-col lg="3" class="text-right">
      <b-button type="submit" variant="primary" :disabled="saveDisabled"
        @click="save">
        <i class="fa fa-save"></i> Save
      </b-button>
      <b-button type="submit" variant="success" :disabled="saveDisabled"
        @click="saveSubmit">
        <i class="fa fa-lock"></i> Save and submit
      </b-button>
    </b-col>
  </b-row>
  <hr />
  <template v-if="isBusy">
    <b-row>
      <b-col class="text-center text-muted">
        <b-spinner class="align-middle" label="Loading..."></b-spinner>
        <strong>Loading...</strong>
      </b-col>
    </b-row>
  </template>
  <template v-else>
    <template v-for="result, result_index in results">
      <b-card v-bind="result" style="margin-bottom: 10px;">
        <h3 slot="header">
          <template>
            [[ result.result_title ]]
          <b-badge>[[ result.result_type ]]</b-badge>
          </template>
        </h3>
        <b-row>
          <b-col lg="6">
            <b-row>
              <b-col cols="4">
                <b>Indicator title</b>
              </b-col>
              <b-col cols="8">
                [[ result.indicator_title ]]
              </b-col>
            </b-row>
          </b-col>
          <b-col lg="6"></b-col>
        </b-row>
        <b-row>
          <b-col lg="6">
            <b-row>
              <b-col cols="4">
                <b>Measurement type</b>
              </b-col>
              <b-col cols="8">
                [[ result.measurement_type ]]
              </b-col>
            </b-row>
          </b-col>
          <b-col lg="6" v-if="result.measurement_type=='Number' && result.measurement_unit_type">
            <b-row>
              <b-col cols="4">
                <b>Unit of measure</b>
              </b-col>
              <b-col cols="8">
                [[ result.measurement_unit_type ]]
              </b-col>
            </b-row>
          </b-col>
        </b-row>
        <b-row>
          <b-col lg="6">
            <b-row>
              <b-col cols="4">
                <b>Baseline year</b>
              </b-col>
              <b-col cols="8">
                [[ result.baseline_year ]]
              </b-col>
            </b-row>
          </b-col>
          <b-col lg="6">
            <b-row>
              <b-col cols="4">
                <b>Baseline value</b>
              </b-col>
              <b-col cols="8">
                [[ result.baseline_value ]]
                <template v-if="result.measurement_type=='Percentage'">
                  %
                </template>
                <template v-else if="result.measurement_unit_type">
                  [[ result.measurement_unit_type ]]
                </template>
              </b-col>
            </b-row>
          </b-col>
        </b-row>
        <b-col>
          <hr />
        </b-col>
        <b-row>
          <b-col>
            <h5>Reporting periods</h5>
            <b-table :fields="['period_start', 'period_end', 'target_value', 'actual_value', 'selectToSubmit']"
              :items="result.periods" responsive>
              <template slot="[period_start]" slot-scope="data">
                  [[ data.item.period_start ]]
              </template>
              <template slot="[period_end]" slot-scope="data">
                  [[ data.item.period_end ]]
              </template>
              <template slot="[target_value]" slot-scope="data">
                [[ data.item.target_value ]]
                <template v-if="result.measurement_type=='Percentage'">
                  %
                </template>
                <template v-else if="result.measurement_unit_type">
                  [[ result.measurement_unit_type ]]
                </template>
              </template>
              <template slot="[actual_value]" slot-scope="data">
                <template v-if="data.item.status==4">
                  [[ data.item.actual_value ]]
                  <template v-if="result.measurement_type=='Percentage'">
                    %
                  </template>
                  <template v-else if="result.measurement_unit_type">
                    [[ result.measurement_unit_type ]]
                  </template>
                </template>
                <template v-else>
                  <b-input-group v-if="result.measurement_type == 'Number'" :append="result.measurement_unit_type">
                    <b-form-input type="number" class="form-control" :required="submitResults"
                      step="0.000001"
                      placeholder="Actual value" name="actual_value"
                      v-model="data.item.actual_value"
                      :disabled="data.item.selectToSubmit=='4'">
                    </b-form-input>
                  </b-input-group>
                  <b-input-group v-if="result.measurement_type == 'Percentage'" append="%">
                    <b-form-input type="number" class="form-control" required="submitResults"
                      step="0.000001"
                      placeholder="Actual value" name="actual_value"
                      v-model="data.item.actual_value"
                      :disabled="data.item.selectToSubmit=='4'">
                    </b-form-input>
                  </b-input-group>
                  <b-input-group v-if="result.measurement_type == 'Qualitative'">
                    <b-form-input type="text" class="form-control" required="submitResults"
                      placeholder="Actual value" name="actual_value"
                      v-model="data.item.actual_value"
                      :disabled="data.item.selectToSubmit=='4'">
                    </b-form-input>
                  </b-input-group>
                  <b-input-group v-if="result.measurement_type == 'Yes/No'">
                    <b-form-select :options="['Yes', 'No']" required="submitResults"
                      v-model="data.item.actual_value"
                      :disabled="data.item.selectToSubmit=='4'">
                    </b-form-select>
                  </b-input-group>
                </template>
              </template>
              <template slot="[selectToSubmit]" slot-scope="data">
                <template v-if="data.item.status==4">
                  <b-btn size="sm" variant="outline-success" disabled>
                    <i class="fa fa-lock"></i> Submitted
                  </b-btn>
                </template>
                <template v-else>
                  <b-form-group>
                    <b-form-radio-group
                      id="btn-radios-2"
                      v-model="data.item.selectToSubmit"
                      buttons
                      button-variant="outline-primary"
                      size="sm"
                      name="radio-btn-outline"
                      @change="checkRequiredField(result_index, data.index)"
                    >
                      <b-form-radio value="3">
                        <i class="fa fa-lock-open"></i>
                        Draft
                      </b-form-radio>
                      <b-form-radio value="4">
                        <i class="fa fa-lock"></i>
                        Submit
                      </b-form-radio>
                    </b-form-radio-group>
                  </b-form-group>
                </template>
              </template>
            </b-table>
          </b-col>
        </b-row>
      </b-card>
    </template>
  </template>
</b-form>
<b-modal id="confirm-submit-modal" title="Confirm submit">
  <p>Would you like to submit all your results, or only
    those you have selected for submission?</p>
  <template slot="modal-footer" slot-scope="{ ok, cancel }">
    <!-- Emulate built in modal footer ok and cancel button actions -->
    <b-button variant="outline-success" @click="confirmSubmitAllResults">
      Submit all
    </b-button>
    <b-button variant="success" @click="confirmSubmitSelectedResults">
      Submit only selected
    </b-button>
    <b-button @click="cancel()">
      Cancel
    </b-button>
  </template>
</b-modal>
{% endblock %}
{% block vuejs %}
<script>
var api_base = "{{ url_for('api.api', _external=True)}}";
var activity_id = "{{ activity_id }}"
Vue.config.devtools = true
var v = new Vue({
  el: "#app",
  delimiters: ["[[", "]]"],
  data() {
    return {
      results: [],
      newRangeModal: {
        'period_start': '2018-07-01',
        'period_end': '2019-06-30',
        'frequency': 'Annually'
      },
      isBusy: true,
      saveDisabled: true,
      submitResults: false,
      activity_title: null,
      activity_id: null
    }
  },
  mounted: function() {
    this.loadResults()
  },
  methods: {
    save() {
      this.submitResults = false;
    },
    saveSubmit() {
      this.submitResults = true
    },
    loadResults() {
      axios
        .get(`${api_base}activities/${activity_id}/results/design.json`
          ).then(response => {
            this.results = this.resultsStatus(response.data.results)
            this.activity_id = response.data.activity_id
            this.activity_title = response.data.activity_title
            this.isBusy = false
            this.saveDisabled = false
          }).catch(error => {
            if (error.response) {
              var msg = "Sorry, something went wrong with the server, and your results data could not be loaded. Try reloading the page."
            } else {
              var msg = "Sorry, it was not possible to communicate with the server, and your results could not be loaded. Try ensuring your internet connection is working."
            }
            this.$bvToast.toast(`${msg}`, {
              title: "Error",
              variant: "danger",
              solid: true,
              noAutoHide: true
            })
            this.isBusy = false
          })
    },
    checkRequiredField(result_id, period_id) {
      if (
          (this.results[result_id].periods[period_id].selectToSubmit == '3') &&
          (this.results[result_id].periods[period_id].actual_value==null)) {
        this.$bvModal.msgBoxOk('You have not entered a value for this field. Please enter a value.', {
            title: 'Warning',
            okVariant: 'danger',
        })
      }
    },
    saveResultsSubmitCheck() {
      if (this.submitResults == true) {
        this.$bvModal.show('confirm-submit-modal')
      } else {
        this.saveResults('save')
      }
      this.submitResults = false
    },
    confirmSubmitSelectedResults() {
      this.$bvModal.hide('confirm-submit-modal')
      this.saveResults('submitSelected')
    },
    confirmSubmitAllResults() {
      this.saveResults('submitAll')
      this.$bvModal.hide('confirm-submit-modal')
    },
    resultsStatus(results) {
      console.log(results)
      var newresults = results.map(result => {
        result['periods'] = result.periods.map(period => {
          period['selectToSubmit'] = period['status']
          return period
        })
        return result
      })
      console.log(newresults)
      return newresults
    },
    saveResults(saveType) {
      axios
        .post(`${api_base}activities/${activity_id}/results/data-entry.json`, {
            results: this.results,
            saveType: saveType
          }).then(response => {
            this.results = this.resultsStatus(response.data.results)
            this.$bvToast.toast(`Your results data has been saved.`, {
              title: "Successfully saved.",
              variant: "success"
            })
          }).catch(response => {
            this.$bvToast.toast(`Sorry, something went wrong, and your results data could not be saved.`, {
              title: "Error.",
              variant: "danger"
            })
          })
    }
  }
})
</script>
{% endblock %}